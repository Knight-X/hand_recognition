<!DOCTYPE html>
<html>
<head>
  <title>Hand recognition</title>
</head>
<body>
  <video id="video">Video stream not available.</video>
  <canvas style="position:absolute;left:0"></canvas>
  <script type="text/javascript">  
    var processing = false;
    var canvas = document.querySelector('canvas');
    var context = canvas.getContext('2d');
    var ws = new WebSocket("ws://" + location.host + "/websocket");
    ws.onmessage = function (evt) {
        processing = false;
        var data = JSON.parse(evt.data);
        console.log(data);
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.beginPath();
        context.arc(data.palm.x, data.palm.y, data.palm.r, 0, 2 * Math.PI, false);
        context.lineWidth = 2;
        context.strokeStyle = 'red';
        context.stroke();
        context.font = "30px Comic Sans MS";
        context.fillStyle = "red";
        context.fillText("Fingers: " + data.fingers.length, 50, 50);
        context.fillText(data.gesture, 50, 100);
        for (var i in data.fingers) {
          var finger = data.fingers[i];
          context.beginPath();
          context.arc(finger.tip.x, finger.tip.y, 2, 0, 2 * Math.PI, false);
          context.stroke();
        }
    };
    
    function takepicture(video) {
      // Write a frame to canvas
      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
      // Write the canvas to an image
      canvas.toBlob(function(blob) {
        console.log("Sent frame");
        ws.send(blob);
      });
    }

    navigator.mediaDevices.getUserMedia({ audio: false, video: true })
    .then(function(mediaStream) {
      var video = document.querySelector('video');
      video.srcObject = mediaStream;
      video.onloadedmetadata = function(e) {
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        setInterval(function() {
          if (!processing) {
            processing = true;
            takepicture(video);
          }
        }, 250);
      };
    })
    .catch(function(err) { console.log(err.name + ": " + err.message); }); // always check for errors at the end
  </script>
</body>
</html>
